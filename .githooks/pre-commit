#!/usr/bin/env bash
set -euo pipefail

# ========================================================================
# Pre-commit hook для OMS проекта
# Проверяет: форматирование, vet, линтинг, race conditions, тесты
# ========================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Pre-commit checks для OMS${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# 1. Check gofmt
echo -e "${BLUE}[1/5]${NC} Проверка форматирования (gofmt)..."
UNFORMATTED=$(gofmt -l . | grep -E "\.go$" || true)
if [[ -n "$UNFORMATTED" ]]; then
  echo -e "${RED}✗ Файлы не отформатированы:${NC}"
  echo "$UNFORMATTED"
  echo -e "${YELLOW}Исправьте: make fmt${NC}"
  exit 1
fi
echo -e "${GREEN}✓ gofmt OK${NC}"
echo ""

# 2. Run go vet
echo -e "${BLUE}[2/5]${NC} Статический анализ (go vet)..."
if command -v go >/dev/null 2>&1; then
  if go vet ./... 2>&1 | tee /tmp/vet-output.txt; then
    echo -e "${GREEN}✓ go vet OK${NC}"
  else
    echo -e "${RED}✗ go vet обнаружил проблемы${NC}"
    cat /tmp/vet-output.txt
    exit 1
  fi
else
  echo -e "${RED}✗ go не найден${NC}"
  exit 1
fi
echo ""

# 3. Run tests with race detector (short mode for speed)
echo -e "${BLUE}[3/5]${NC} Тесты с race detector (short mode)..."
if go test -race -short ./... 2>&1 | tee /tmp/test-output.txt; then
  echo -e "${GREEN}✓ Тесты пройдены, race conditions не обнаружены${NC}"
else
  echo -e "${RED}✗ Тесты не прошли или обнаружены race conditions!${NC}"
  echo -e "${YELLOW}Для детальной проверки: make test-race${NC}"
  cat /tmp/test-output.txt
  exit 1
fi
echo ""

# 4. Run golangci-lint if available
echo -e "${BLUE}[4/5]${NC} Линтинг (golangci-lint)..."
if command -v golangci-lint >/dev/null 2>&1; then
  if golangci-lint run --timeout=5m 2>&1 | tee /tmp/lint-output.txt; then
    echo -e "${GREEN}✓ golangci-lint OK${NC}"
  else
    echo -e "${RED}✗ golangci-lint обнаружил проблемы${NC}"
    cat /tmp/lint-output.txt
    exit 1
  fi
else
  echo -e "${YELLOW}⚠ golangci-lint не установлен (опционально)${NC}"
  echo -e "${YELLOW}  Установите: brew install golangci-lint${NC}"
fi
echo ""

# 5. Check for common issues
echo -e "${BLUE}[5/5]${NC} Проверка распространённых проблем..."

# Check for TODO/FIXME in staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
if [[ -n "$STAGED_GO_FILES" ]]; then
  TODO_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -n "TODO\|FIXME" 2>/dev/null | wc -l || echo "0")
  if [[ "$TODO_COUNT" -gt 0 ]]; then
    echo -e "${YELLOW}⚠ Найдено $TODO_COUNT TODO/FIXME комментариев${NC}"
    echo "$STAGED_GO_FILES" | xargs grep -n "TODO\|FIXME" 2>/dev/null || true
  fi
fi

# Check for debug prints
DEBUG_PRINTS=$(echo "$STAGED_GO_FILES" | xargs grep -n "fmt.Print\|log.Print" 2>/dev/null | grep -v "// " || true)
if [[ -n "$DEBUG_PRINTS" ]]; then
  echo -e "${YELLOW}⚠ Найдены debug print statements:${NC}"
  echo "$DEBUG_PRINTS"
fi

echo -e "${GREEN}✓ Дополнительные проверки завершены${NC}"
echo ""

# Success
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  ✓ Все проверки пройдены!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${BLUE}Коммит разрешён. Для полной проверки запустите:${NC}"
echo -e "${BLUE}  make test-race && make cover${NC}"
echo ""

exit 0
