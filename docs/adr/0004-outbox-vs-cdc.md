# ADR 0004: Outbox против CDC

Status: **Accepted** • Date: 2025-09-27

## TL;DR
- Выбрали Transactional Outbox: событие пишется в БД вместе с бизнес-операцией, публикация — асинхронно.
- CDC и 2PC/XA рассмотрены, но отклонены из-за операционной сложности.

## Контекст
- Нужна надёжная доставка событий, согласованная с состоянием БД.
- Кандидаты: Transactional Outbox, CDC, 2PC/XA.

## Решение
- В `OrderService` писать бизнес-изменение и запись в `outbox` в одной транзакции.
- Паблишер с ретраями и DLQ отправляет события в брокер; consumer — идемпотентный.

## Альтернативы
- **CDC (Debezium):** минимум кода на продюсере, но высокая операционная сложность, события формируются вне транзакции.
- **2PC/XA:** теоретическая атомарность между БД и брокером, но высокая сложность и риск блокировок.

## Последствия
- **Плюсы:** практичные гарантии at-least-once, контроль на уровне приложения, нет глобальных транзакций.
- **Минусы:** нужны воркеры/publisher, мониторинг DLQ, управление ростом `outbox` (TTL/partitioning).
