# ADR 0003: Стратегия ключей идемпотентности

Status: **Accepted** • Date: 2025-09-27

## TL;DR
- Все мутирующие RPC требуют `Idempotency-Key` в metadata.
- Храним `request_hash`, статус обработки и финальный ответ в `idempotency_keys`.
- Повтор с тем же ключом возвращает сохранённый ответ; конфликт payload → `AlreadyExists`/`InvalidArgument`.

## Контекст
- Клиенты и промежуточные системы могут повторять запросы; нужно предотвратить двойные эффекты.

## Решение
- Обязательный `Idempotency-Key` для всех POST/мутаций.
- Хранить `request_hash`, статус `processing|done|failed`, ответ и TTL.
- Повторный запрос возвращает кешированный ответ; конфликт payload → ошибка.

## Альтернативы
- «Естественная» идемпотентность через доменные ограничения — недостаточно для транспорта и сложных операций.
- Серверная генерация ключей — проще клиенту, но слабее гарантии при ретраях.

## Последствия
- **Плюсы:** предсказуемые ретраи, защита от двойных эффектов, понятная семантика для клиента.
- **Минусы:** накладные расходы хранения, управление TTL, необходимость rate limiting против злоупотреблений.
