# üîÅ Idempotency

> –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

**–í–µ—Ä—Å–∏—è:** v2.0 | **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-10-01 | **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω–æ

---

## üéØ TL;DR
- –í—Å–µ –º—É—Ç–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç `Idempotency-Key`; –ø–æ–≤—Ç–æ—Ä –æ—Ç–¥–∞—ë—Ç —Ç–æ—Ç –∂–µ –æ—Ç–≤–µ—Ç/–∫–æ–¥.
- –•—Ä–∞–Ω–µ–Ω–∏–µ: —Ç–∞–±–ª–∏—Ü–∞ `idempotency_keys` + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—ç—à; TTL 24‚Äì72 —á.
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–ª—é—á–∞ —Å –¥—Ä—É–≥–∏–º `request_hash` ‚Üí `AlreadyExists`/`InvalidArgument`.
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π ‚Äî —á–µ—Ä–µ–∑ inbox/`processed_events` –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ.

## –ü–æ–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç–ø–µ—á–∞—Ç–æ–∫
- `request_hash = hash(method + route/rpc + canonicalized body + critical headers)`.
- –ö–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω; –ø–æ–≤—Ç–æ—Ä —Å –∏–Ω—ã–º `request_hash` –∑–∞–ø—Ä–µ—â—ë–Ω.

## –•—Ä–∞–Ω–∏–ª–∏—â–µ `idempotency_keys`
- –ü–æ–ª—è: `key`, `request_hash`, `response_body`, `status (processing|done|failed)`, `http_status/grpc_code`, `ttl_at`, timestamps.
- –ò–Ω–¥–µ–∫—Å—ã: PK(`key`), `ttl_at`, `status`; Redis/–∫—ç—à –ø–æ –∂–µ–ª–∞–Ω–∏—é.

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª
1. INSERT `processing` + `request_hash`.
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏—é.
3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: UPDATE ‚Üí `done`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç/–∫–æ–¥.
4. –ü—Ä–∏ –æ—à–∏–±–∫–µ: UPDATE ‚Üí `failed`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏.
5. –ü–æ–≤—Ç–æ—Ä: `processing` ‚Üí 425/409; `done` ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç; `failed` ‚Üí –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É.

## TTL –∏ –æ—á–∏—Å—Ç–∫–∞
- TTL 24‚Äì72 —á (–∫–æ–Ω—Ñ–∏–≥); cron —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.
- –ü–æ—Å–ª–µ TTL –∫–ª—é—á —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º.

## gRPC –∏ —Å–æ–±—ã—Ç–∏—è
- –ü–µ—Ä–µ–¥–∞—á–∞ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ metadata `idempotency-key`.
- –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –≤–µ–¥—É—Ç `processed_events` –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.

## –ú–µ—Ç—Ä–∏–∫–∏/–∞–ª–µ—Ä—Ç—ã
- `idempotency_conflicts_total`, `idempotency_processing_gauge`, `idempotency_retries_total`.
- –ê–ª–µ—Ä—Ç –ø—Ä–∏ —Ä–æ—Å—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–ª–∏ ¬´–∑–∞–≤–∏—Å—à–∏—Ö¬ª `processing`.

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –•—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å (–±–µ–∑ –æ—Ç–≤–µ—Ç–∞) ‚Äî –ø—Ä–æ—â–µ, –Ω–æ –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å response.
- –£–∫–æ—Ä–æ—á–µ–Ω–Ω—ã–π TTL ‚Äî –º–µ–Ω—å—à–µ —Ç–∞–±–ª–∏—Ü–∞, –Ω–æ –ø–æ–≤—Ç–æ—Ä—ã —Å—Ç–∞–Ω—É—Ç –Ω–æ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π.

