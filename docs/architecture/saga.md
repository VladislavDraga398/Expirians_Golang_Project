# üîÑ Saga Orchestration

> –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ Saga Pattern

**–í–µ—Ä—Å–∏—è:** v2.0 | **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-10-01 | **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω–æ

---

## üéØ TL;DR
- –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫: Create ‚Üí Reserve ‚Üí Pay ‚Üí Confirm.
- –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏: –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ ‚Äî Release ‚Üí Cancel; –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî Refund ‚Üí Cancel.
- –¢–∞–π–º–∞—É—Ç—ã –∏ —Ä–µ—Ç—Ä–∞–∏: –∫–æ—Ä–æ—Ç–∫–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff + jitter; `unknown` ‚Üí —Å–Ω–∞—á–∞–ª–∞ reconcile.
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: —à–∞–≥–∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã –±–µ–∑ ¬´–¥–≤–æ–π–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞¬ª, —Å–æ–±—ã—Ç–∏—è ‚Äî —á–µ—Ä–µ–∑ outbox, consumer —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–î–µ—Ç–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ —Å–∞–≥: —Å–æ—Å—Ç–æ—è–Ω–∏—è, —à–∞–≥–∏, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏, —Ç–∞–π–º–∞—É—Ç—ã/—Ä–µ—Ç—Ä–∞–∏, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∫—Ä–∞–µ–≤—ã–µ —Å–ª—É—á–∞–∏.

## –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞–∫–∞–∑–∞
```mermaid
stateDiagram-v2
  [*] --> pending
  pending --> reserved: Reserve OK
  reserved --> paid: Payment OK
  paid --> confirmed: Confirm OK
  reserved --> canceled: Reserve Fail / Cancel
  paid --> refunded: Cancel after Pay / Refund OK
  confirmed --> [*]
  canceled --> [*]
  refunded --> [*]
```

## –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
```mermaid
sequenceDiagram
  autonumber
  participant C as Client
  participant O as OrderService (Orchestrator)
  participant I as InventoryService
  participant P as PaymentService

  C->>O: CreateOrder
  O->>O: Persist Order(pending) + Outbox(StartSaga)
  O-->>C: 201 {status: pending}

  O->>I: Reserve(order_items)
  alt Reserve OK
    I-->>O: reserved
    O->>P: Pay(order_id, amount)
    alt Pay OK
      P-->>O: paid
      O->>O: Update Order -> confirmed + Outbox(OrderStatusChanged)
    else Pay Fail
      P-->>O: fail
      O->>I: Release(order_items)
      O->>O: Update Order -> canceled + Outbox(OrderStatusChanged)
    end
  else Reserve Fail
    I-->>O: fail
    O->>O: Update Order -> canceled + Outbox(OrderStatusChanged)
  end
```

## –¢–∞–π–º–∞—É—Ç—ã –∏ —Ä–µ—Ç—Ä–∞–∏
- Reserve: –¥–µ–¥–ª–∞–π–Ω 1‚Äì5 —Å; –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏ jitter.
- Pay (Hold/Capture): –¥–µ–¥–ª–∞–π–Ω 3‚Äì10 —Å; 3‚Äì5 –ø–æ–ø—ã—Ç–æ–∫; –ø—Ä–∏ `indeterminate` ‚Äî reconcile —Å—Ç–∞—Ç—É—Å–∞.
- Release/Refund (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏): –¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.

## –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ (transient): —Å–µ—Ç—å/—Ç–∞–π–º–∞—É—Ç—ã ‚Äî —Ä–µ—Ç—Ä–∞–∏.
- –ë–∏–∑–Ω–µ—Å-–æ—Ç–∫–∞–∑—ã: –Ω–µ—Ö–≤–∞—Ç–∫–∞ —Å—Ç–æ–∫–∞, –æ—Ç–∫–ª–æ–Ω—ë–Ω –ø–ª–∞—Ç—ë–∂ ‚Äî –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏.
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ö–æ–¥ ‚Äî —Å–Ω–∞—á–∞–ª–∞ reconcile, –∑–∞—Ç–µ–º —Ä–µ—à–µ–Ω–∏–µ.

## –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤
- –í–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã –ø–æ `order_id`/`payment_id`.
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã optimistic locking –ø–æ `orders.version`.
- –°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —á–µ—Ä–µ–∑ outbox; –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é.

## –†–µ-—ç–Ω—Ç–µ—Ä–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —à–∞–≥–∏ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞, —Å–≤–µ—Ä—è—è—Å—å —Å —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–∫–∞–∑–∞.
- –ü—Ä–∏ —Å–±–æ–µ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏: –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è.

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
- –û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–∞ `order_id` (—à–∞—Ä–¥–∏–Ω–≥/–æ—á–µ—Ä–µ–¥—å –ø–æ –∫–ª—é—á—É).
- –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –≤–µ—Ä—Å–∏–π: —Ä–µ—Ç—Ä–∞–π —Å backoff; –ø—Ä–∏ ¬´–≥–æ—Ä—è—á–µ–º¬ª –∫–ª—é—á–µ ‚Äî –æ—á–µ—Ä–µ–¥—å/–ª–æ–∫ –Ω–∞ –∫–ª—é—á.

## –ö—Ä–∞–µ–≤—ã–µ —Å–ª—É—á–∞–∏
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã: –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –¥–µ–ª–∞—Ç—å reconcile –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–æ–π.
- –ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑–µ—Ä–≤ (–≤–Ω–µ MVP): –ª–∏–±–æ ¬´–≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ¬ª, –ª–∏–±–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫.
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã (202): –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏; –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `paid`.
- –°–±–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏: –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Ä–µ—Ç—Ä–∞–∏, DLQ, —Ä—É—á–Ω–æ–π runbook.

## –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- –°–ø–∞–Ω—ã: –Ω–∞ –∫–∞–∂–¥—ã–π —à–∞–≥; –∞—Ç—Ä–∏–±—É—Ç—ã `order.id`, `saga.step`, `retry.attempt`, `dep.name`.
- –ú–µ—Ç—Ä–∏–∫–∏: `saga_step_duration_seconds`, `saga_flow_transitions_total`, `order_e2e_latency_seconds`.

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –•–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—è (—Å–ª–∞–±–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å, —Å–ª–æ–∂–Ω—ã–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏).
- TCC (—Ç—Ä–µ–±—É–µ—Ç Try/Confirm/Cancel —É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π).
- Workflow-–¥–≤–∏–∂–æ–∫ (Temporal) –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

