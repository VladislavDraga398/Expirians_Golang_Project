# Runbooks

> Runbooks для операционной поддержки

**Версия:** v2.2 | **Обновлено:** 2026-02-20 | **Статус:** Актуально

---

## TL;DR
- Сначала стабилизируем, затем диагностируем; логируем все действия.
- Основные сценарии: рост DLQ, всплески p95, всплеск конфликтов идемпотентности, зависшие саги, двойной эффект, недоступность провайдера, компрометация секретов.

## Принципы
- Сначала стабилизируем систему, затем ищем корневую причину.
- Приоритет — безопасность данных и финансов.

## Рост DLQ / бэклог outbox
- Диагностика
  - Проверить `outbox_pending_records`, `outbox_oldest_pending_age_seconds`, `outbox_dlq_total`.
  - Состояние брокера, лаги консумеров, ошибки авторизации.
  - Логи publisher на предмет причин ошибок.
- Действия
  - Масштабировать воркеры/батчи publisher.
  - Если брокер недоступен — эскалация платформенной команде; публикацию приостановить.
  - Репроцессинг DLQ батчами; включить расширенное логирование на консумерах.
  - Сначала dry-run:
    - `make dlq-reprocess LIMIT=50`
  - Затем controlled replay (явный execute):
    - `make dlq-reprocess LIMIT=50 EXECUTE=1 FROM_NEWEST=1`
- Критерий завершения
  - Старейший pending < 2 мин, DLQ стабилен, error rate ниже порога.
- Риски
  - Дубликаты — потребители обязаны быть идемпотентны.

## Cleanup idempotency ключей (TTL)
- Диагностика
  - Проверить логи `idempotency-cleanup-worker` и метрики cleanup.
  - Убедиться, что `ttl_at` в `idempotency_keys` не накапливает устаревшие записи.
- Действия
  - Проверить env-параметры:
    - `OMS_IDEMPOTENCY_CLEANUP_INTERVAL`
    - `OMS_IDEMPOTENCY_CLEANUP_BATCH_SIZE`
  - При росте таблицы увеличить частоту cleanup и размер batch.
  - При высокой нагрузке выполнять изменения постепенно, без резкого роста batch.
- Критерий завершения
  - Cleanup работает стабильно, число удалений предсказуемо, таблица не растет бесконтрольно.

## Всплески p95 задержки API
- Диагностика
  - Сравнить серверную и клиентскую латентность в трейсах.
  - Насыщение пула БД/блокировки/медленные запросы.
  - Латентность зависимостей (Inventory/Payment), состояние CB.
- Действия
  - Включить rate limiting; активировать circuit breaker.
  - Масштабировать сервис; настроить пул БД; оптимизировать горячие запросы/индексы.
- Критерий завершения
  - p95 в пределах SLO 10–15 мин; нормальный error rate.

## Всплеск конфликтов идемпотентности
- Диагностика
  - `idempotency_conflicts_total` по клиентам.
  - Логи с одинаковым ключом и разным `request_hash`.
- Действия
  - Лимитировать «шумных» клиентов; донести правила генерации ключей.
  - Подстроить TTL при выявленном паттерне злоупотребления.
- Критерий завершения
  - Конфликты вернулись к базовому уровню; частота 409/AlreadyExists нормализовалась.

## Застревание саг (долгая обработка)
- Диагностика
  - Дашборды саг: долгие шаги; какая зависимость тормозит.
  - Статус воркера оркестратора для конкретного `order_id`.
- Действия
  - Перезапустить воркер; убедиться в ре-энтерабельности.
  - Включить watchdog для долгих шагов.
  - Ручной force cancel/confirm с аудитом при необходимости.
- Критерий завершения
  - Снижение числа долгих саг; отсутствие новых зависаний.

## «Двойной эффект» (двойной refund/confirm)
- Диагностика
  - Сверить логи/события и ключи дедупликации.
  - Проверить БД на повторяющиеся терминальные статусы.
- Действия
  - Немедленно остановить проблемный воркер/шаг.
  - Reconcile с платёжным провайдером; вручную исправить состояние заказа с аудитом.
  - Ужесточить ключи идемпотентности и дедупликацию консумеров.
- Критерий завершения
  - Состояние исправлено; добавлены регрессионные тесты.

## Недоступность внешнего провайдера (Inventory/Payment)
- Диагностика
  - Ошибки gRPC-клиента; состояние CB; статус провайдера.
- Действия
  - Режим деградации: ставить операции в очередь; уведомить о задержках.
  - Увеличить интервалы ретраев; уведомить стейкхолдеров.
- Критерий завершения
  - Провайдер восстановлен; error rate нормализовался.

## Компрометация секретов
- Действия
  - Немедленно ротировать ключи/пароли.
  - Аудит доступа в секрет-менеджере; поиск злоупотреблений.
  - Отозвать токены; коммуникация по политике ИБ.
- Критерий завершения
  - Новые секреты задействованы; аномалий доступа нет.

## Graceful shutdown зависает
- Диагностика
  - Проверить, на каком шаге зависание: gRPC stop, saga drain или shutdown HTTP.
  - Проверить наличие долго работающих saga задач и внешних вызовов.
  - Проверить таймауты `terminationGracePeriodSeconds` и внутренних shutdown-timeout.
- Действия
  - Если `GracefulStop` не завершился в SLA, применить hard stop.
  - Увеличить shutdown timeout только после анализа длительных операций.
  - Добавить/усилить метрики shutdown и логирование in-flight задач.
- Критерий завершения
  - Остановка повторяемо укладывается в таймаут.
  - Нет потерь критичных операций при плановых рестартах.
