# Security

> Стратегия безопасности для OMS: аутентификация, авторизация, защита данных

**Версия:** v2.0 | **Обновлено:** 2025-10-01 | **Статус:** Актуально

---

## TL;DR

- **Аутентификация:** mTLS внутри, JWT/OIDC (или API Key для MVP) снаружи
- **Авторизация:** RBAC, принцип наименьших привилегий, аудит админ-действий
- **Секреты:** Secret Manager + регулярная ротация
- **Защита:** rate limiting, валидация протобуфом, размер payload, masking PII
- **Мониторинг:** authn/z ошибки, rate limit, доступ к секретам

---

## Цели

Обеспечить безопасные коммуникации, минимизировать утечки и обеспечить аудит действий.

## Аутентификация
- Внутренний gRPC: mTLS между сервисами; сервисные идентичности (например, SPIFFE/SPIRE или эквивалент).
- Внешний API (если есть): JWT/OIDC bearer-токены; для MVP допустим API Key для m2m.

## Авторизация (RBAC)
- Роли: `service`, `operator`, `viewer`, `auditor`.
- Политики: на уровне RPC-методов (например, `RefundOrder` — ограничен), админ-операции требуют повышенной роли.
- Принцип наименьших привилегий для доступа к БД/брокеру и сервисных аккаунтов.

## Управление секретами
- Использовать Secret Manager (Vault/Cloud). Не хранить секреты в репо/логах.
- Ротация: плановая и экстренная. Аудит доступа к секретам.

## Транспортная безопасность
- TLS 1.2+ для gRPC-эндпоинтов; предпочтительно mTLS для east-west трафика.
- Современные шифросuites; отключение слабых протоколов.

## Валидация и защита от злоупотреблений
- Протобуф-схемы + доп. бизнес-валидации (диапазоны qty, поддерживаемые валюты, пределы сумм).
- Rate limiting на публичном входе и/или на уровне сервиса.
- Злоупотребление идемпотентностью: троттлинг повторов с одинаковыми ключами; жёсткий TTL.
- Лимиты размера payload.

## Аудит логов
- Логировать значимые бизнес-действия: смена статусов, запуск refund/cancel, админ-вмешательства.
- Структурированные логи с `who`, `what`, `when`, `correlation_id`, `order_id`.
- Неизменяемое хранение для критичных аудитов (WORM/SIEM) при необходимости.

## Модель угроз (высокий уровень)
- MITM или подмена межсервисных вызовов → mTLS, NetworkPolicy, сервисные идентичности.
- «Двойной эффект» (повторный refund/confirm) → идемпотентные шаги, ключи дедупликации, reconcile-потоки.
- DoS через массовые мутации → rate limiting, circuit breaker.
- Утечка секретов → secret manager, маскирование, запрет логирования чувствительных данных.
- Инъекции/пробелы в валидации → строгие схемы, проверки, лимиты размеров.
- Эскалация привилегий → RBAC, разделение ролей, аудит админ-эндпоинтов.

## Приватность и ПДн (PII)
- В `orders` хранить только `customer_id`; избегать ПДн в ядре.
- Маскировать ПДн в логах/трейсах; шифровать «на покое» при требованиях политики.

## Метрики и алерты
- Частота ошибок authn/z, тренды 401/403.
- Срабатывания rate limit; аномалии по клиенту/IP.
- Аномалии доступа к секретам по журналам секрет-менеджера.

